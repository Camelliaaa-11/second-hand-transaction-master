@startuml
'!theme plain
skinparam sequenceMessageAlign center
skinparam responseMessageBelowArrow true

actor "å–å®¶" as Seller
participant "Chat.vue" as ChatPage
participant "Flask API" as API
participant "Agent Service" as AgentService
participant "SellerAgent" as Agent
participant "Database" as DB
participant "Socket.IO" as Socket
actor "ä¹°å®¶" as Buyer

== å–å®¶è¯·æ±‚AIæ™ºèƒ½å»ºè®® ==
Seller -> ChatPage: ç‚¹å‡»"ğŸ¤–æ™ºèƒ½å›å¤"æŒ‰é’®
activate ChatPage
ChatPage -> ChatPage: getSellerAdvice(msg)
ChatPage -> ChatPage: æå–ä¹°å®¶å‡ºä»·\nextractBuyerOffer(msg.content)
ChatPage -> ChatPage: æ‰“å¼€æ™ºèƒ½å›å¤å¼¹çª—\nshowSellerAdviceDialog = true
ChatPage -> ChatPage: loadingSellerAdvice = true

ChatPage -> API: POST /api/agent/seller-advice
note left
  è¯·æ±‚å‚æ•°ï¼š
  {
    user_id: å–å®¶ID,
    item_id: å•†å“ID,
    item_listed_price: æ ‡ä»·,
    seller_min_price: åº•ä»·,
    buyer_offer: ä¹°å®¶å‡ºä»·,
    is_urgent_sale: æ˜¯å¦æ€¥å”®,
    buyer_id: ä¹°å®¶ID,
    item_category: å•†å“ç±»åˆ«,
    item_condition: å•†å“æˆè‰²
  }
end note

activate API
API -> AgentService: è½¬å‘è¯·æ±‚åˆ°æ™ºèƒ½ä½“æœåŠ¡
activate AgentService

AgentService -> DB: è·å–ä¹°å®¶ä¿¡ç”¨è¯„åˆ†
activate DB
DB --> AgentService: buyer_credit_score
deactivate DB

AgentService -> DB: è·å–å¸‚åœºæ•°æ®\n(åŒç±»å•†å“å‡ä»·)
activate DB
DB --> AgentService: market_data
deactivate DB

AgentService -> Agent: åˆ›å»ºSellerAgentå®ä¾‹
activate Agent
Agent -> Agent: åˆå§‹åŒ–è®®ä»·ä¸Šä¸‹æ–‡\nNegotiationContext
Agent -> Agent: åº”ç”¨è®®ä»·è§„åˆ™\napply_bargain_rules()

Agent -> Agent: åˆ¤æ–­æ˜¯å¦æ¥å—ä¹°å®¶å‡ºä»·
alt ä¹°å®¶å‡ºä»· >= å–å®¶åº•ä»·
    Agent -> Agent: action = "ACCEPT"
    Agent -> Agent: ç”Ÿæˆæ¥å—è¯æœ¯
else ä¹°å®¶å‡ºä»· < å–å®¶åº•ä»· ä¸”æœ‰è®®ä»·ç©ºé—´
    Agent -> Agent: action = "COUNTER_OFFER"
    Agent -> Agent: è®¡ç®—åˆç†è¿˜ä»·ä»·æ ¼
    Agent -> Agent: ç”Ÿæˆè¿˜ä»·è¯æœ¯
else ä¹°å®¶å‡ºä»·è¿‡ä½
    Agent -> Agent: action = "REJECT"
    Agent -> Agent: ç”Ÿæˆæ‹’ç»è¯æœ¯
end

Agent --> AgentService: è¿”å›AIå»ºè®®
note left
  {
    action: "COUNTER_OFFER",
    price: 70,
    message: "70å…ƒå¯ä»¥å‡ºæ‰‹ï¼Œæ‚¨çœ‹æ€ä¹ˆæ ·ï¼Ÿ",
    reasoning: "ä¹°å®¶å‡ºä»·ç•¥ä½ï¼Œå»ºè®®è¿˜ä»·..."
  }
end note
deactivate Agent

AgentService --> API: AIå»ºè®®ç»“æœ
deactivate AgentService
API --> ChatPage: è¿”å›AIå»ºè®®
deactivate API

ChatPage -> ChatPage: sellerAdvice = å»ºè®®æ•°æ®
ChatPage -> ChatPage: customSellerPrice = å»ºè®®ä»·æ ¼
ChatPage -> ChatPage: loadingSellerAdvice = false
ChatPage --> Seller: æ˜¾ç¤ºAIå»ºè®®
note right of Seller
  æ˜¾ç¤ºå†…å®¹ï¼š
  - å»ºè®®åŠ¨ä½œæ ‡ç­¾
  - AIæ¨èä»·æ ¼
  - å»ºè®®è¯æœ¯
  - ç­–ç•¥åˆ†æ
  - å¯è°ƒæ•´ä»·æ ¼å’Œè¯æœ¯
end note
deactivate ChatPage

== å–å®¶é‡‡çº³AIå»ºè®®å¹¶å‘é€ ==
Seller -> ChatPage: ç‚¹å‡»"é‡‡çº³å¹¶å‘é€"
activate ChatPage
ChatPage -> ChatPage: adoptSellerAdvice()

alt å–å®¶ä¿®æ”¹äº†ä»·æ ¼
    ChatPage -> API: POST /api/v1/bargain/handle
    note left
      {
        item_id,
        buyer_id,
        action: "counter",
        counter_price: è‡ªå®šä¹‰ä»·æ ¼
      }
    end note
    activate API
    API -> DB: æ›´æ–°è®®ä»·è®°å½•
    activate DB
    DB --> API: æ›´æ–°æˆåŠŸ
    deactivate DB
    API --> ChatPage: è¿˜ä»·æˆåŠŸ
    deactivate API
end

ChatPage -> Socket: emit('send_msg', {\n  senderId: å–å®¶ID,\n  receiverId: ä¹°å®¶ID,\n  content: AIç”Ÿæˆçš„è¯æœ¯,\n  msg_type: "æ–‡æœ¬"\n})
activate Socket
Socket -> DB: ä¿å­˜æ¶ˆæ¯
activate DB
DB --> Socket: ä¿å­˜æˆåŠŸ
deactivate DB
Socket -> Buyer: emit('new_msg', æ¶ˆæ¯)
Socket --> ChatPage: æ¶ˆæ¯å‘é€æˆåŠŸ
deactivate Socket

ChatPage -> ChatPage: æœ¬åœ°æ·»åŠ æ¶ˆæ¯åˆ°åˆ—è¡¨
ChatPage -> ChatPage: showSuccessToast("AIå»ºè®®å·²å‘é€")
ChatPage -> ChatPage: showSellerAdviceDialog = false

alt AIå»ºè®®æ˜¯æ¥å— ä¸” æœªä¿®æ”¹ä»·æ ¼
    ChatPage -> ChatPage: handleBargain(msg, 'accept')
    ChatPage -> API: POST /api/v1/bargain/handle\n{item_id, buyer_id, action: "accept"}
    activate API
    API -> DB: æ›´æ–°å•†å“ä»·æ ¼
    activate DB
    DB --> API: ä»·æ ¼æ›´æ–°æˆåŠŸ
    deactivate DB
    API -> DB: æ›´æ–°è®®ä»·çŠ¶æ€ä¸º"å·²æ¥å—"
    activate DB
    DB --> API: çŠ¶æ€æ›´æ–°æˆåŠŸ
    deactivate DB
    API --> ChatPage: å¤„ç†æˆåŠŸ
    deactivate API
    ChatPage -> ChatPage: æ˜¾ç¤º"å·²åŒæ„ï¼Œä»·æ ¼å·²ä¿®æ”¹"
end

ChatPage --> Seller: AIå›å¤å·²å‘é€
deactivate ChatPage

Buyer -> Buyer: æ”¶åˆ°å–å®¶å›å¤

@enduml
